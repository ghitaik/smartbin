<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartBin</title>
  <style>
    body{font-family:system-ui,Segoe UI,Helvetica,Arial,sans-serif;max-width:840px;margin:24px auto;padding:0 16px}
    .row{display:flex;gap:8px;align-items:center}
    #log{margin-top:10px;padding:8px;background:#f6f6f6;border-radius:6px;white-space:pre-wrap}
    img{max-width:100%}
    button{padding:8px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff}
    input[type=text]{flex:1;padding:8px;border:1px solid #ccc;border-radius:8px}
  </style>
</head>
<body>
  <h1>SmartBin ♻️</h1>
  <p>Upload a photo and get the German bin suggestion.</p>

  <div class="row">
    <label>API URL</label>
    <input id="api" type="text" value="https://smartbin-api-4ycp.onrender.com" />
    <button id="use">Use</button>
  </div>

  <div class="row" style="margin-top:8px;">
    <input id="file" type="file" accept="image/*" />
    <button id="go">Predict</button>
  </div>

  <div id="log"></div>
  <div id="out"></div>

<script>
const $ = s => document.querySelector(s);
let API = localStorage.getItem('smartbin_api') || $('#api').value;
$('#api').value = API;
$('#use').onclick = () => {
  API = $('#api').value.trim().replace(/\/+$/, '');
  localStorage.setItem('smartbin_api', API);
  log(`Using API: ${API}`);
};
function log(t){ $('#log').textContent = t; }

async function compress(file, maxSide=1600, quality=0.82){
  const img = await createImageBitmap(file);
  let {width:w, height:h} = img;
  const s = Math.max(w,h);
  if (s>maxSide){ const k = maxSide/s; w=Math.round(w*k); h=Math.round(h*k); }
  const cv = document.createElement('canvas'); cv.width=w; cv.height=h;
  const cx = cv.getContext('2d'); cx.drawImage(img,0,0,w,h);
  const blob = await new Promise(res=>cv.toBlob(res,'image/jpeg',quality));
  return new File([blob], file.name || 'upload.jpg', {type:'image/jpeg'});
}

$('#go').onclick = async () => {
  const f = $('#file').files[0];
  if(!f){ log('Pick a file first'); return; }

  // compress big images to avoid timeouts
  let up = f; if (f.size > 1_200_000) up = await compress(f, 1600, 0.82);

  // sanity pings (helpful when debugging 404/Failed to fetch)
  try {
    const h = await fetch(API + '/health', {cache:'no-store'});
    if(!h.ok) { log(`Health error ${h.status}`); return; }
  } catch(e){ log('Health fetch failed: '+e); return; }

  const fd = new FormData();
  fd.append('file', up, up.name);

  let r;
  try{
    r = await fetch(API + '/predict', { method:'POST', body:fd });
  }catch(e){
    log('Network error: ' + e);
    return;
  }

  if(!r.ok){
    const txt = await r.text();
    log(`Error: HTTP ${r.status}  — ${txt}`);
    return;
  }

  const json = await r.json();
  log(JSON.stringify(json, null, 2));

  const url = URL.createObjectURL(up);
  $('#out').innerHTML = `<img src="${url}" alt="preview">`;
};
</script>
</body>
</html>
